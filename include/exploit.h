#pragma once

#include <functional>
#include <PcapLiveDevice.h>

#include "offset.h"
#include "defines.h"

#ifdef DEBUG
#define hexdump(p) PacketBuilder::hexPrint(p)
#define hexdump_verbose(p) (void) p

#else
#define hexdump(p) (void) p
#define hexdump_verbose(p) (void) p
#endif

class PacketBuilder {
public:
    static void hexPrint(const pcpp::Packet &packet);

    static pcpp::Packet lcpEchoReply(const pcpp::MacAddress &source_mac, const pcpp::MacAddress &target_mac,
                                     uint16_t session, uint8_t id, uint32_t magic_number);

    static pcpp::Packet pado(const pcpp::MacAddress &source_mac, const pcpp::MacAddress &target_mac,
                             const uint8_t *ac_cookie, size_t ac_cookie_len,
                             const uint8_t *host_uniq, size_t host_uniq_len);

    static pcpp::Packet pads(const pcpp::MacAddress &source_mac, const pcpp::MacAddress &target_mac,
                             const uint8_t *host_uniq, size_t host_uniq_len);

    static pcpp::Packet padt(const pcpp::MacAddress &source_mac, const pcpp::MacAddress &target_mac);

    static pcpp::Packet lcpRequest(const pcpp::MacAddress &source_mac, const pcpp::MacAddress &target_mac);

    static pcpp::Packet lcpAck(const pcpp::MacAddress &source_mac, const pcpp::MacAddress &target_mac, uint8_t id);

    static pcpp::Packet ipcpRequest(const pcpp::MacAddress &source_mac, const pcpp::MacAddress &target_mac);

    static pcpp::Packet ipcpNak(const pcpp::MacAddress &source_mac, const pcpp::MacAddress &target_mac, uint8_t id);

    static pcpp::Packet ipcpAck(const pcpp::MacAddress &source_mac, const pcpp::MacAddress &target_mac, uint8_t id,
                                const uint8_t *option, size_t option_len);

    static pcpp::Packet icmpv6Echo(const pcpp::MacAddress &source_mac, const pcpp::MacAddress &target_mac,
                                   const pcpp::IPv6Address &source_ipv6, const pcpp::IPv6Address &target_ipv6);

    static pcpp::Packet icmpv6Na(const pcpp::MacAddress &source_mac, const pcpp::MacAddress &target_mac,
                                 const pcpp::IPv6Address &source_ipv6, const pcpp::IPv6Address &target_ipv6);

    static pcpp::Packet pinCpu0(const pcpp::MacAddress &source_mac, const pcpp::MacAddress &target_mac);

    static pcpp::Packet maliciousLcp(const pcpp::MacAddress &source_mac, const pcpp::MacAddress &target_mac,
                                     const uint8_t *overflow, size_t overflow_len);

    static pcpp::Packet lcpTerminate(const pcpp::MacAddress &source_mac, const pcpp::MacAddress &target_mac);
};

class LcpEchoHandler {
public:
    explicit LcpEchoHandler(const std::string &iface);

    void run();

    void stop();

    ~LcpEchoHandler();

private:
    pcpp::PcapLiveDevice *dev;
    bool running{};
};

class Exploit {
public:
    Exploit() = default;

    ~Exploit();

    int setFirmwareVersion(FirmwareVersion version);

    int setInterface(const std::string &iface);

    void setStage1(const std::vector<uint8_t> &&stage1_data);

    void setStage2(const std::vector<uint8_t> &&stage2_data);

    void setAutoRetry(bool value);

    void closeInterface();

    void updateSourceMac(uint64_t value);

    uint64_t kdlsym(uint64_t addr) const;

    int lcp_negotiation() const;

    int ipcp_negotiation() const;

    int ppp_negotiation(const std::function<std::vector<uint8_t>(Exploit *)> &cb = nullptr,
                        bool ignore_initial_req = false);

    static std::vector<uint8_t> build_fake_ifnet(Exploit *self);

    static std::vector<uint8_t> build_overflow_lle(Exploit *self);

    static std::vector<uint8_t> build_fake_lle(Exploit *self);

    static std::vector<uint8_t> build_first_rop(Exploit *self, uint64_t fake_lle_len, uint64_t rop2_len);

    static std::vector<uint8_t> build_second_rop(Exploit *self);

    int stage0();

    int stage1();

    int stage2();

    int stage3();

    int stage4();

    int run();

    pcpp::PcapLiveDevice *dev{};
    uint64_t pppoe_softc{};
    uint64_t pppoe_softc_list{};
    uint64_t kaslr_offset{};
    pcpp::MacAddress target_mac, source_mac;
    pcpp::IPv6Address target_ipv6;
    OffsetsFirmware offs{};
    std::vector<uint8_t> stage1_bin{};
    std::vector<uint8_t> stage2_bin{};
    bool auto_retry{};
};
